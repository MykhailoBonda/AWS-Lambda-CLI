# View Lambda logs using AWS CloudWatch

This section will explain about how to view the logs generated by lambda programs when they are running. AWS CloudWatch 
will be the service used here to fetch the logs. Understanding how to view the logs will help in debugging, while doing
this tutorial series, if you get stuck or when the lambda throws errors.

We will deploy the same hello world lambda, with a log statement.

#### (1) Create lambda function
```shell script
‚ûú  export LAMBDA_ROLE_ARN=arn:aws:iam::919191919191:role/lambda-cli-role
‚ûú  export AWS_REGION=us-east-1
‚ûú  export AWS_PROFILE=lambda-cli-user
‚ûú  echo "exports.handler =  async (event) => {
  const payload = {
    date: new Date(),
    message: 'Hello World With Logs'
  };
  console.log(JSON.stringify(payload));
  return JSON.stringify(payload);
};" > helloWorldWithLog.js
```

#### (2) Build, Deploy and Invoke the lambda
> Note: we will use the same `lambda-cli-role`

```shell script
‚ûú  zip -r /tmp/helloWorldWithLog.js.zip helloWorldWithLog.js
‚ûú  aws lambda create-function \
       --region "$AWS_REGION" \
       --function-name helloWorldWithLog \
       --handler 'helloWorldWithLog.handler' \
       --runtime nodejs10.x \
       --role "$LAMBDA_ROLE_ARN" \
       --zip-file 'fileb:///tmp/helloWorldWithLog.js.zip' \
       --profile "$AWS_PROFILE"
‚ûú  aws lambda invoke --function-name helloWorldWithLog \
       --log-type Tail \
       --payload '{}' \
       --profile "$AWS_PROFILE" outputfile.txt
```
#### (3) View Logs
AWS CloudWatch is a monitoring and observability service. Here we can view the logs from Lambda. 
Few key concepts here to be understood are, 
1. Log Event -  a single log event logged by a resource like lambda. 
2. Log Stream - is a sequence of log events and represents sequence of events from a resource like Lambda.
3. Log Groups - is a group of log streams. This defines common properties like retention and access control.

##### (3.1) Describe log groups
First, we will get the list of log groups available. This will list all the lambda as log groups, if no specific 
setting is done.  

```shell script
‚ûú  aws logs describe-log-groups --profile "$AWS_PROFILE"
```
> output :
```json
{"logGroups": [{
    "logGroupName": "/aws/lambda/helloWorldWithLog",
    "creationTime": 1576000780000,
    "metricFilterCount": 0,
    "arn": "arn:aws:logs:us-east-1:919191919191:log-group:/aws/lambda/helloWorldWithLog:*",
    "storedBytes": 0
  },{
    "logGroupName": "/aws/lambda/helloLambdaCLIWorld",
    "creationTime": 1576000770000,
    "metricFilterCount": 0,
    "arn": "arn:aws:logs:us-east-1:919191919191:log-group:/aws/lambda/helloLambdaCLIWorld:*",
    "storedBytes": 0
}]}
```
##### (3.2) Describe log streams
We will get the log streams that are created for the log group `/aws/lambda/helloWorldWithLog` received above.

```shell script
‚ûú export LOG_GROUP_NAME="/aws/lambda/helloWorldWithLog"
‚ûú aws logs describe-log-streams --log-group-name "$LOG_GROUP_NAME" --profile "$AWS_PROFILE"  
```
> output : The output should contain minimum one log stream. We need this to get the events.
```json
{
    "logStreams": [
        {
            "logStreamName": "2019/12/13/[$LATEST]aBcDEeFG1H2IjKlM3nOPQrS4Tuv5W6xYZaB",
            "creationTime": 15762000000,
            "firstEventTimestamp": 1576250000000,
            "lastEventTimestamp": 1576250000004,
            "lastIngestionTime": 1576250000006,
            "uploadSequenceToken": "1234567890123456789012345678901234567890",
            "arn": "arn:aws:logs:us-east-1:919191919191:log-group:/aws/lambda/helloWorldWithLog:log-stream:2019/12/13/[$LATEST]aBcDEeFG1H2IjKlM3nOPQrS4Tuv5W6xYZaB",
            "storedBytes": 0
        }
    ]
}
```
##### (3.3) View the log events (i.e., logs)
We will use the log stream to view the logs generated by `helloWorldWithLog`.
> Note: 
>1. Replace the sample values below with your actual log stream name.
>2. If the value of log stream name contains special character like '$', escape them.

```shell script
‚ûú  export LOG_STREAM_NAME="2019/12/13/[\$LATEST]aBcDEeFG1H2IjKlM3nOPQrS4Tuv5W6xYZaB"
‚ûú  aws logs get-log-events --log-group-name "$LOG_GROUP_NAME" --log-stream-name "$LOG_STREAM_NAME" --profile "$AWS_PROFILE"
```
> output : 
>1. The output should contain the log output of `console.log(JSON.stringify(payload));` in lambda.
>2. The output will also contain useful event information like time of request, request id, request end time etc.,

```json
{
    "events": [
        {
            "timestamp": 15762000000,
            "message": "START RequestId: a123b456-c123-456a-b123-1ab2bc3c4567 Version: $LATEST\n",
            "ingestionTime": 15761999999
        },
        {
            "timestamp": 15762000004,
            "message": "2019-01-01T16:34:27.675Z\ta123b456-c123-456a-b123-1ab2bc3c4567\tINFO\t{\"date\":\"2019-01-01T16:34:27.674Z\",\"message\":\"Hello Lambda CLI World\"}\n",
            "ingestionTime": 15761999999
        },
        {
            "timestamp": 15762000008,
            "message": "END RequestId: a123b456-c123-456a-b123-1ab2bc3c4567\n",
            "ingestionTime": 15761999999
        },
        {
            "timestamp": 15762000012,
            "message": "REPORT RequestId: a123b456-c123-456a-b123-1ab2bc3c4567\tDuration: 56.85 ms\tBilled Duration: 100 ms\tMemory Size: 128 MB\tMax Memory Used: 76 MB\tInit Duration: 164.81 ms\t\n",
            "ingestionTime": 15761999999
        }
    ],
    "nextForwardToken": "f/123456789012345678901234567890123456789012345678901234567",
    "nextBackwardToken": "b/12345678901234567890123456789012345678901234567890123456"
}
```

#### (4) Teardown
Lets remove the `helloWorldWithLog` Lambda created above.

```shell script
‚ûú  aws lambda delete-function --function-name helloWorldWithLog --profile "$AWS_PROFILE"
```

üèÅ **Congrats !** You observed the logs of a lambda after deploying it successfully. üèÅ

**Next**: [Packaging With Dependencies](06-packaging-lambda-with-dependencies.md)
 
